#!/bin/sh -e
#
# This script illustrates how to build a specific version of the Linux kernel
# from scratch. This is mainly intended as a template for copy & paste, and as
# an example for individual scripts.
#
# This script uses the gnueabi toolchain, see the file
# ../../../../../../trunk/src/target/u-boot/scripts/README
#
#
# Environment variables:
#
# SVN points to the root of the local copy of the OpenMoko SVN tree (the tree
# must be checked out already), e.g.,
# SVN=/home/moko/svn.openmoko.org/
#
# KERNEL specifies the kernel version we use, e.g.,
# KERNEL=2.6.24
#
# KERNELSRC_DIR, if defined, specifies the directory where the kernel source
# tarball resides. By default, we use ".".
# KERNELSRC_DIR=/wherever
#
# UBOOT_DIR, if defined, specifies the absolute (!) path to the directory where
# u-boot has been built. By default, we use ./u-boot
# UBOOT_DIR=/wherever/u-boot
#
# PLATFORM specifies the name of the platform we build the kernel for, e.g.,
# one of
# PLATFORM=gta01
# PLATFORM=gta02
#
# SVN_REV, if defined, specifies which SVN revision we use, e.g.,
# SVN_REV=4014
#

# wget http://ftp.kernel.org/pub/linux/kernel/v2.6/linux-${KERNEL}.tar.bz2

tar xfj ${KERNELSRC_DIR:-.}/linux-${KERNEL}.tar.bz2

# we need this for "mkimage", which makes uImages
PATH=$PATH:${UBOOT_DIR:-`pwd`/u-boot}/tools

cd linux-$KERNEL

base=$SVN/branches/src/target/kernel/2.6.24.x

ln -sf $base/patches

defconfig=$base/config/defconfig-$PLATFORM
[ -z "$SVN_REV" ] ||
  ( cd patches && svn update -r$SVN_REV . $defconfig; )

quilt push -a
cp $defconfig .config
make ARCH=arm CROSS_COMPILE=arm-angstrom-linux-gnueabi- oldconfig
make ARCH=arm CROSS_COMPILE=arm-angstrom-linux-gnueabi- uImage
