/*
 * Initial main.c file generated by Glade. Edit as required.
 * Glade will not overwrite this file.
 */

#ifdef HAVE_CONFIG_H
#  include <config.h>
#endif

#include <gtk/gtk.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <errno.h>
#include <signal.h>

#include "interface.h"
#include "support.h"
#include "widgets.h"
#include "iconmgr.h"
#include "pkglist.h"
#include "treeview.h"
#include "initwidgets.h"

static void 
handle_sigusr1 (int value)
{
  GtkWidget *win;

  win = get_widget_pointer (FIC_WIDGET_WINDOW_MAIN_WINDOW);
  if (win == NULL)
    {
      return;
    }
  gtk_window_present (GTK_WINDOW (win));
}

static pid_t 
testlock (char *fname)
{
  int fd;
  struct flock fl;

  fd = open (fname, O_WRONLY, S_IWUSR);
  if (fd < 0)
    {
      if (errno == ENOENT)
        {
          return 0;
        }
      else
        {
          perror ("Test lock open file");
          return -1;
        }
    }

  fl.l_type = F_WRLCK;
  fl.l_whence = SEEK_SET;
  fl.l_start = 0;
  fl.l_len = 0;

  if (fcntl (fd, F_GETLK, &fl) < 0)
    {
      close (fd);
      return -1;
    }
  close (fd);

  if (fl.l_type == F_UNLCK)
    return 0;

  return fl.l_pid;
}

static void 
setlock (char *fname)
{
  int fd;
  struct flock fl;

  fd = open (fname, O_WRONLY|O_CREAT, S_IWUSR);
  if (fd < 0)
    {
      perror ("Set lock open file");
      return ;
    }

  fl.l_type = F_WRLCK;
  fl.l_whence = SEEK_SET;
  fl.l_start = 0;
  fl.l_len = 0;

  if (fcntl (fd, F_SETLK, &fl) < 0)
    {
      perror ("Lock file");
      close (fd);
    }
}

int
main (int argc, char *argv[])
{
  GtkWidget *window1;
  GtkWidget *menu1;
  GtkWidget *menumark;
  pid_t     lockapp;

#ifdef ENABLE_NLS
  bindtextdomain (GETTEXT_PACKAGE, PACKAGE_LOCALE_DIR);
  bind_textdomain_codeset (GETTEXT_PACKAGE, "UTF-8");
  textdomain (GETTEXT_PACKAGE);
#endif

  gtk_set_locale ();
  gtk_init (&argc, &argv);

  add_pixmap_directory (PACKAGE_DATA_DIR "/pixmaps");
  add_pixmap_directory (PACKAGE_DATA_DIR "/" PACKAGE "/pixmaps");
  add_pixmap_directory ("/usr/share/pixmaps");

  lockapp = testlock ("/tmp/appmgr.lock");
  if (lockapp > 0)
    {
      kill (lockapp, SIGUSR1);
      return 0;
    }
  setlock ("/tmp/appmgr.lock");
  /*
   * The following code was added by Glade to create one of each component
   * (except popup menus), just so that you see something after building
   * the project. Delete any components that you don't want shown initially.
   */
  window1 = create_appmgr ();
  save_main_window (window1);
  init_main_window_widget (window1);

  menu1 = create_menu1 ();
  save_application_menu (menu1);

  menumark = create_menu2 ();
  save_mark_menu (menumark);

  init_package_status_icon ();
  init_package_view ();

  init_package_list_data();
  init_filter_menu ();

  //gtk_window_set_decorated (GTK_WINDOW (window1), FALSE);
  gtk_widget_show (window1);

  //test display application icon.
  update_application_icon_from_file ("unkown.png");

  signal (SIGUSR1, handle_sigusr1);

  gtk_main ();
  return 0;
}
